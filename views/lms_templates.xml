<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="courses_page" name="LMS Courses">
        <t t-call="website.layout">
            <div class="container mt-4">
                <div class="row">
                    <!-- Sidebar Filters -->
                    <div class="col-lg-3">
                        <div class="card">
                            <div class="card-header">
                                <h5>Filters</h5>
                            </div>
                            <div class="card-body">
                                <form method="get">
                                    <div class="mb-3">
                                        <label class="form-label">Category</label>
                                        <select name="category" class="form-select">
                                            <option value="">All Categories</option>
                                            <t t-foreach="categories" t-as="category">
                                                <option t-att-value="category.id" 
                                                        t-att-selected="category_id == category.id">
                                                    <t t-esc="category.name"/> (<t t-esc="category.course_count"/>)
                                                </option>
                                            </t>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Level</label>
                                        <select name="level" class="form-select">
                                            <option value="">All Levels</option>
                                            <option value="beginner">Beginner</option>
                                            <option value="intermediate">Intermediate</option>
                                            <option value="advanced">Advanced</option>
                                            <option value="all">All Levels</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Courses List -->
                    <div class="col-lg-9">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1>Online Courses</h1>
                            <form method="get" class="d-flex">
                                <input type="text" name="search" class="form-control me-2" 
                                       placeholder="Search courses..." t-att-value="search"/>
                                <button type="submit" class="btn btn-outline-primary">Search</button>
                            </form>
                        </div>
                        
                        <div class="row">
                            <t t-foreach="courses" t-as="course">
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100 course-card">
                                        <img t-if="course.image" t-att-src="'/web/image/lms.course/%s/image' % course.id" 
                                             class="card-img-top" alt="Course image"/>
                                        <div class="card-body">
                                            <h5 class="card-title" t-esc="course.name"/>
                                            <p class="card-text text-muted" t-esc="course.short_description or course.description"/>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="h5 mb-0" t-esc="'Free' if course.is_free else '₹%.2f' % course.price"/>
                                                <span class="badge bg-primary" t-esc="course.level"/>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <a t-att-href="'/lms/course/%s' % course.id" 
                                               class="btn btn-primary w-100">View Course</a>
                                        </div>
                                    </div>
                                </div>
                            </t>
                        </div>
                        
                        <t t-if="not courses">
                            <div class="text-center py-5">
                                <h3>No courses found</h3>
                                <p class="text-muted">Try adjusting your search filters</p>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="course_detail_page" name="LMS Course Detail">
        <t t-call="website.layout">
            <div class="container mt-4">
                <div class="row">
                    <div class="col-lg-8">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/lms/courses">Courses</a></li>
                                <li class="breadcrumb-item active" t-esc="course.name"/>
                            </ol>
                        </nav>
                        
                        <h1 t-esc="course.name"/>
                        <p class="lead" t-esc="course.subtitle"/>
                        
                        <div class="d-flex align-items-center mb-3">
                            <t t-if="course.instructor_id">
                                <span class="me-3">Instructor: <strong t-esc="course.instructor_id.name"/></span>
                            </t>
                            <span class="badge bg-primary me-2" t-esc="course.level"/>
                            <span class="badge bg-secondary" t-esc="course.language"/>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Course Description</h5>
                            </div>
                            <div class="card-body">
                                <div t-field="course.description" t-options="{'widget': 'html'}"/>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>What You'll Learn</h5>
                            </div>
                            <div class="card-body">
                                <div t-field="course.learning_outcomes" t-options="{'widget': 'html'}"/>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5>Curriculum</h5>
                            </div>
                            <div class="card-body">
                                <div class="accordion" id="courseCurriculum">
                                    <t t-foreach="course.modules" t-as="module">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button" type="button" 
                                                        data-bs-toggle="collapse" 
                                                        t-att-data-bs-target="'#module%s' % module.id">
                                                    <t t-esc="module.name"/>
                                                    <span class="badge bg-secondary ms-2" t-esc="len(module.contents)"/>
                                                </button>
                                            </h2>
                                            <div t-att-id="'module%s' % module.id" 
                                                 class="accordion-collapse collapse">
                                                <div class="accordion-body">
                                                    <div class="list-group">
                                                        <t t-foreach="module.contents" t-as="content">
                                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <i t-att-class="'fas me-2 ' + 
                                                                        {'video': 'fa-video', 'pdf': 'fa-file-pdf', 
                                                                         'text': 'fa-file-alt', 'quiz': 'fa-question-circle'}.get(content.content_type, 'fa-file')"/>
                                                                    <span t-esc="content.name"/>
                                                                </div>
                                                                <small class="text-muted" t-esc="'%.0f min' % content.duration"/>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card sticky-top" style="top: 20px;">
                            <div class="card-body text-center">
                                <t t-if="course.image">
                                    <img t-att-src="'/web/image/lms.course/%s/image' % course.id" 
                                         class="img-fluid mb-3" alt="Course image"/>
                                </t>
                                
                                <h3 t-esc="'Free' if course.is_free else '₹%.2f' % course.price"/>
                                
                                <div class="d-grid gap-2">
                                    <t t-if="is_enrolled">
                                        <a t-att-href="'/lms/learning/%s' % course.id" 
                                           class="btn btn-success">Continue Learning</a>
                                    </t>
                                    <t t-else="">
                                        <a t-att-href="'/lms/course/enroll/%s' % course.id" 
                                           class="btn btn-primary">Enroll Now</a>
                                    </t>
                                </div>
                                
                                <div class="mt-3 text-start">
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span>Duration:</span>
                                        <strong t-esc="'%.1f hours' % course.duration"/>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span>Modules:</span>
                                        <strong t-esc="course.total_modules"/>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span>Lectures:</span>
                                        <strong t-esc="course.total_lectures"/>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span>Students:</span>
                                        <strong t-esc="course.current_students"/>
                                    </div>
                                    <div class="d-flex justify-content-between py-2">
                                        <span>Certificate:</span>
                                        <strong>Yes</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="learning_page" name="LMS Learning">
        <t t-call="website.layout">
            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar Curriculum -->
                    <div class="col-lg-3 col-xl-2 bg-light sidebar">
                        <div class="p-3">
                            <h5 t-esc="course.name"/>
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" 
                                     t-att-style="'width: %s%%' % enrollment.progress"
                                     t-att-aria-valuenow="enrollment.progress">
                                    <t t-esc="'%.0f%%' % enrollment.progress"/>
                                </div>
                            </div>
                            
                            <div class="accordion curriculum-sidebar">
                                <t t-foreach="course.modules" t-as="module">
                                    <div class="accordion-item">
                                        <h6 class="accordion-header">
                                            <button class="accordion-button" type="button" 
                                                    data-bs-toggle="collapse" 
                                                    t-att-data-bs-target="'#sidebarModule%s' % module.id">
                                                <t t-esc="module.name"/>
                                            </button>
                                        </h6>
                                        <div t-att-id="'sidebarModule%s' % module.id" 
                                             class="accordion-collapse collapse show">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush">
                                                    <t t-foreach="module.contents" t-as="content">
                                                        <a t-att-href="'/lms/learning/%s?module=%s&amp;content=%s' % (course.id, module.id, content.id)"
                                                           t-att-class="'list-group-item list-group-item-action ' + 
                                                           ('active' if current_content_id == content.id else '')">
                                                            <i t-att-class="'fas me-2 ' + 
                                                                {'video': 'fa-video', 'pdf': 'fa-file-pdf', 
                                                                 'text': 'fa-file-alt', 'quiz': 'fa-question-circle'}.get(content.content_type, 'fa-file')"/>
                                                            <span t-esc="content.name"/>
                                                            <t t-if="content.is_preview">
                                                                <span class="badge bg-info ms-1">Preview</span>
                                                            </t>
                                                        </a>
                                                    </t>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Content Area -->
                    <div class="col-lg-9 col-xl-10 main-content">
                        <div class="p-4">
                            <t t-if="current_content_id">
                                <t t-set="content" t-value="request.env['lms.content'].browse(current_content_id)"/>
                                
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h2 t-esc="content.name"/>
                                        <nav aria-label="breadcrumb">
                                            <ol class="breadcrumb">
                                                <li class="breadcrumb-item">
                                                    <a t-att-href="'/lms/learning/%s' % course.id">Curriculum</a>
                                                </li>
                                                <li class="breadcrumb-item" t-esc="content.module_id.name"/>
                                                <li class="breadcrumb-item active" t-esc="content.name"/>
                                            </ol>
                                        </nav>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline-primary" 
                                                t-att-data-url="'/lms/content/complete'"
                                                t-att-data-content-id="content.id"
                                                t-att-data-enrollment-id="enrollment.id"
                                                onclick="markAsComplete(this)">
                                            Mark as Complete
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Content Renderer -->
                                <div class="content-renderer">
                                    <t t-if="content.content_type == 'video'">
                                        <div class="video-player">
                                            <t t-if="content.video_source == 'youtube'">
                                                <div class="ratio ratio-16x9">
                                                    <iframe t-att-src="'https://www.youtube.com/embed/' + content.video_url" 
                                                            frameborder="0" allowfullscreen></iframe>
                                                </div>
                                            </t>
                                            <t t-elif="content.video_source == 'vimeo'">
                                                <div class="ratio ratio-16x9">
                                                    <iframe t-att-src="'https://player.vimeo.com/video/' + content.video_url" 
                                                            frameborder="0" allowfullscreen></iframe>
                                                </div>
                                            </t>
                                            <t t-else="">
                                                <video controls class="w-100">
                                                    <source t-att-src="'/web/content/lms.content/%s/video_file' % content.id" 
                                                            type="video/mp4"/>
                                                    Your browser does not support the video tag.
                                                </video>
                                            </t>
                                        </div>
                                    </t>
                                    
                                    <t t-elif="content.content_type == 'pdf'">
                                        <div class="pdf-viewer">
                                            <iframe t-att-src="'/web/content/lms.content/%s/document_file' % content.id" 
                                                    class="w-100" style="height: 600px;"></iframe>
                                        </div>
                                    </t>
                                    
                                    <t t-elif="content.content_type == 'text'">
                                        <div class="text-content">
                                            <div t-field="content.text_content" t-options="{'widget': 'html'}"/>
                                        </div>
                                    </t>
                                    
                                    <t t-elif="content.content_type == 'quiz'">
                                        <div class="quiz-content text-center">
                                            <h4>Associated Quiz</h4>
                                            <p>This content has an associated quiz that needs to be completed.</p>
                                            <a t-att-href="'/lms/quiz/start/%s' % content.quiz_id.id" 
                                               class="btn btn-primary">Start Quiz</a>
                                        </div>
                                    </t>
                                </div>
                                
                                <!-- Navigation -->
                                <div class="d-flex justify-content-between mt-4">
                                    <t t-set="prev_content" t-value="content.get_previous_content()"/>
                                    <t t-set="next_content" t-value="content.get_next_content()"/>
                                    
                                    <t t-if="prev_content">
                                        <a t-att-href="'/lms/learning/%s?module=%s&amp;content=%s' % (course.id, prev_content.module_id.id, prev_content.id)"
                                           class="btn btn-outline-primary">
                                            ← Previous
                                        </a>
                                    </t>
                                    <t t-if="next_content">
                                        <a t-att-href="'/lms/learning/%s?module=%s&amp;content=%s' % (course.id, next_content.module_id.id, next_content.id)"
                                           class="btn btn-primary ms-auto">
                                            Next →
                                        </a>
                                    </t>
                                    <t t-elif="enrollment.progress >= 100">
                                        <a href="#" class="btn btn-success ms-auto" 
                                           onclick="completeCourse()">
                                            Complete Course
                                        </a>
                                    </t>
                                </div>
                            </t>
                            <t t-else="">
                                <div class="text-center py-5">
                                    <h3>Welcome to the course!</h3>
                                    <p class="text-muted">Select a lesson from the sidebar to start learning.</p>
                                    <t t-if="course.modules">
                                        <a t-att-href="'/lms/learning/%s?module=%s&amp;content=%s' % (course.id, course.modules[0].id, course.modules[0].contents[0].id if course.modules[0].contents else '')"
                                           class="btn btn-primary">Start First Lesson</a>
                                    </t>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function markAsComplete(button) {
                    const url = button.getAttribute('data-url');
                    const contentId = button.getAttribute('data-content-id');
                    const enrollmentId = button.getAttribute('data-enrollment-id');
                    
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            'content_id': parseInt(contentId),
                            'enrollment_id': parseInt(enrollmentId),
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            button.classList.remove('btn-outline-primary');
                            button.classList.add('btn-success');
                            button.textContent = 'Completed';
                            button.disabled = true;
                            
                            // Update progress bar
                            document.querySelector('.progress-bar').style.width = data.progress + '%';
                            document.querySelector('.progress-bar').textContent = Math.round(data.progress) + '%';
                        }
                    });
                }
                
                function completeCourse() {
                    if (confirm('Are you sure you want to mark this course as complete?')) {
                        // Implementation for course completion
                        window.location.reload();
                    }
                }
            </script>
            
            <style>
                .sidebar {
                    height: calc(100vh - 56px);
                    overflow-y: auto;
                    position: fixed;
                    left: 0;
                }
                .main-content {
                    margin-left: 25%;
                }
                .curriculum-sidebar .accordion-button {
                    padding: 0.5rem 1rem;
                    font-size: 0.9rem;
                }
                .curriculum-sidebar .accordion-body {
                    padding: 0;
                }
                @media (max-width: 991.98px) {
                    .sidebar {
                        position: static;
                        height: auto;
                    }
                    .main-content {
                        margin-left: 0;
                    }
                }
            </style>
        </t>
    </template>

    <template id="quiz_page" name="LMS Quiz">
        <t t-call="website.layout">
            <div class="container mt-4">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h4 t-esc="quiz.name"/>
                                <t t-if="quiz.time_limit">
                                    <div class="quiz-timer">
                                        Time Remaining: <span id="timer" t-esc="'%s:00' % quiz.time_limit"/>
                                    </div>
                                </t>
                            </div>
                            <div class="card-body">
                                <form id="quizForm">
                                    <t t-foreach="attempt.questions" t-as="question" t-index="index">
                                        <div class="question-card mb-4 p-3 border rounded">
                                            <h5>
                                                <span t-esc="index + 1"/>.
                                                <span t-field="question.question_id.name" t-options="{'widget': 'html'}"/>
                                            </h5>
                                            
                                            <t t-if="question.question_id.question_type == 'multiple_choice'">
                                                <div class="answer-options">
                                                    <t t-foreach="question.question_id.answers" t-as="answer">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   t-att-name="'question_%s' % question.question_id.id"
                                                                   t-att-value="answer.id"
                                                                   t-att-id="'answer_%s' % answer.id"/>
                                                            <label class="form-check-label" t-att-for="'answer_%s' % answer.id">
                                                                <t t-field="answer.text" t-options="{'widget': 'html'}"/>
                                                            </label>
                                                        </div>
                                                    </t>
                                                </div>
                                            </t>
                                            
                                            <t t-elif="question.question_id.question_type == 'true_false'">
                                                <div class="answer-options">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" 
                                                               t-att-name="'question_%s' % question.question_id.id"
                                                               value="true" t-att-id="'answer_true_%s' % question.question_id.id"/>
                                                        <label class="form-check-label" t-att-for="'answer_true_%s' % question.question_id.id">
                                                            True
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" 
                                                               t-att-name="'question_%s' % question.question_id.id"
                                                               value="false" t-att-id="'answer_false_%s' % question.question_id.id"/>
                                                        <label class="form-check-label" t-att-for="'answer_false_%s' % question.question_id.id">
                                                            False
                                                        </label>
                                                    </div>
                                                </div>
                                            </t>
                                            
                                            <t t-elif="question.question_id.question_type == 'essay'">
                                                <div class="form-group">
                                                    <textarea class="form-control" rows="5" 
                                                              t-att-name="'question_%s' % question.question_id.id"
                                                              placeholder="Type your answer here..."></textarea>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                    
                                    <div class="text-center">
                                        <button type="button" class="btn btn-primary btn-lg" onclick="submitQuiz()">
                                            Submit Quiz
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                <t t-if="quiz.time_limit">
                let timeLeft = <t t-esc="quiz.time_limit * 60"/>;
                const timerElement = document.getElementById('timer');
                
                function updateTimer() {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        submitQuiz();
                    } else {
                        timeLeft--;
                        setTimeout(updateTimer, 1000);
                    }
                }
                
                updateTimer();
                </t>
                
                function submitQuiz() {
                    const form = document.getElementById('quizForm');
                    const formData = new FormData(form);
                    const answers = {};
                    
                    // Collect answers
                    <t t-foreach="attempt.questions" t-as="question">
                        answers[<t t-esc="question.question_id.id"/>] = {
                            type: '<t t-esc="question.question_id.question_type"/>',
                            answers: Array.from(formData.getAll('question_<t t-esc="question.question_id.id"/>')).map(id => parseInt(id)),
                            answer: formData.get('question_<t t-esc="question.question_id.id"/>')
                        };
                    </t>
                    
                    fetch('/lms/quiz/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            attempt_id: <t t-esc="attempt.id"/>,
                            answers: answers
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.is_passed) {
                                alert(`Quiz submitted successfully! Your score: ${data.score}% - You passed!`);
                            } else {
                                alert(`Quiz submitted successfully! Your score: ${data.score}% - You did not pass.`);
                            }
                            window.location.href = data.redirect_url;
                        }
                    });
                }
            </script>
        </t>
    </template>
</odoo>